locksmith:
  reboot_strategy: "off"
storage:
  directories:
  - filesystem: root
    group:
      id: 0
    mode: 493
    path: /opt
    user:
      id: 0
  - filesystem: root
    group:
      id: 0
    mode: 493
    path: /opt/kubetmp
    user:
      id: 0
  - filesystem: root
    group:
      id: 0
    mode: 493
    path: /opt/bin
    user:
      id: 0
  - filesystem: root
    group:
      id: 0
    mode: 493
    path: /opt/cni
    user:
      id: 0
  - filesystem: root
    group:
      id: 0
    mode: 493
    path: /opt/cni/bin
    user:
      id: 0
  files:
  - contents:
      inline: |
        {{ .Machine.ObjectMeta.Name }}
    filesystem: root
    group:
      id: 0
    mode: 420
    path: /etc/hostname
    user:
      id: 0
  - contents:
      remote:
        url: https://github.com/containernetworking/plugins/releases/download/v0.7.5/cni-plugins-amd64-v0.7.5.tgz
    filesystem: root
    group:
      id: 0
    mode: 420
    path: /opt/kubetmp/cni-plugins.tar.gz
    user:
      id: 0
  - contents:
      remote:
        url: https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.12.0/crictl-v1.12.0-linux-amd64.tar.gz
    filesystem: root
    group:
      id: 0
    mode: 420
    path: /opt/kubetmp/crictl.tar.gz
    user:
      id: 0
  - contents:
      remote:
        url: https://storage.googleapis.com/kubernetes-release/release/v{{.Machine.Spec.Version}}/bin/linux/amd64/kubeadm
    filesystem: root
    group:
      id: 0
    mode: 493
    path: /opt/bin/kubeadm
    user:
      id: 0
  - contents:
      remote:
        url: https://storage.googleapis.com/kubernetes-release/release/v{{.Machine.Spec.Version}}/bin/linux/amd64/kubectl
    filesystem: root
    group:
      id: 0
    mode: 493
    path: /opt/bin/kubectl
    user:
      id: 0
  - contents:
      remote:
        url: https://storage.googleapis.com/kubernetes-release/release/v{{.Machine.Spec.Version}}/bin/linux/amd64/kubelet
    filesystem: root
    group:
      id: 0
    mode: 493
    path: /opt/bin/kubelet
    user:
      id: 0
  - contents:
      inline: |
        {
          "exec-opts": ["native.cgroupdriver=systemd"],
          "iptables": false,
          "ip-masq": false
        }
    filesystem: root
    group:
      id: 0
    mode: 420
    path: /etc/docker/daemon.json
    user:
      id: 0
  - contents:
      inline: |+
        [Global]
        auth-url=https://os.detss.corpintra.net:5000/v3/
        username="E415_s_os1pi020"
        password="KJFs!3CuCu%kjYuyfd87"
        region="null"
        tenant-id="b9abf84da3944b85a61cab7aecf97d77"
        domain-name="null"

    filesystem: root
    group:
      id: 0
    mode: 384
    path: /etc/kubernetes/cloud.conf
    user:
      id: 0
  - contents:
      inline: ""
    filesystem: root
    group:
      id: 0
    mode: 384
    path: /etc/certs/cacert
    user:
      id: 0
  - contents:
      inline: |
        ip_vs
    filesystem: root
    group:
      id: 0
    mode: 420
    path: /etc/modules-load.d/ipvs.conf
    user:
      id: 0
  - contents:
      inline: |
        ip_vs_rr
    filesystem: root
    group:
      id: 0
    mode: 420
    path: /etc/modules-load.d/ipvsrr.conf
    user:
      id: 0
  - contents:
      inline: |
        ip_vs_sh
    filesystem: root
    group:
      id: 0
    mode: 420
    path: /etc/modules-load.d/ipvssh.conf
    user:
      id: 0
  - contents:
      inline: |
        ip_vs_wrr
    filesystem: root
    group:
      id: 0
    mode: 420
    path: /etc/modules-load.d/ipvswrr.conf
    user:
      id: 0
  - contents:
      inline: |
        br_netfilter
    filesystem: root
    group:
      id: 0
    mode: 420
    path: /etc/modules-load.d/br_netfilter.conf
    user:
      id: 0
  - contents:
      inline: '{{ .KubeadmConfig | EscapeNewLines }}'
    filesystem: root
    group:
      id: 0
    mode: 420
    path: /etc/kubernetes/kubeadm_config.yaml
    user:
      id: 0
systemd:
  units:
  - enabled: true
    name: docker.service
  - contents: |
      [Unit]
      Description=Unpack CNI and CRICTL into the right places.
      Before=kubelet.service

      [Service]
      Type=oneshot
      ExecStartPre=/usr/bin/tar -C /opt/bin -xzf /opt/kubetmp/crictl.tar.gz
      ExecStart=/usr/bin/tar -C /opt/cni/bin -xzf /opt/kubetmp/cni-plugins.tar.gz
      ExecStartPost=/usr/bin/systemctl disable unpack.service

      [Install]
      WantedBy=multi-user.target
    enabled: true
    name: unpack.service
  - contents: |
      [Unit]
      Description=kubelet: The Kubernetes Node Agent
      Documentation=http://kubernetes.io/docs/

      [Service]
      ExecStart=/opt/bin/kubelet
      Restart=always
      StartLimitInterval=0
      RestartSec=10

      [Install]
      WantedBy=multi-user.target
    dropins:
    - contents: |
        # Note: This dropin only works with kubeadm and kubelet v1.11+
        [Service]
        Environment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"
        Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"
        # This is a file that "kubeadm init" and "kubeadm join" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically
        EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
        # This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use
        # the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.
        EnvironmentFile=-/etc/default/kubelet
        ExecStart=
        ExecStart=/opt/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
      name: 10-kubeadm.conf
    enabled: true
    name: kubelet.service
  - contents: |-
      [Unit]
      Description=Initialise Kubernetes worker node.
      After=kubelet.service
      Requires=coreos-metadata.service

      [Service]
      Type=oneshot
      Environment="PATH=/usr/bin:/usr/sbin:/opt/bin:/opt/cni/bin:/bin/sbin"
      ExecStart=/opt/bin/kubeadm join --ignore-preflight-errors=all --config /etc/kubernetes/kubeadm_config.yaml
      ExecStartPost=/opt/bin/kubectl --kubeconfig /etc/kubernetes/kubelet.conf annotate --overwrite node %H machine={{ .Machine.ObjectMeta.Namespace }}/{{ .Machine.ObjectMeta.Name }}
      ExecStartPost=/usr/bin/systemctl disable kubeadm.service

      [Install]
      WantedBy=multi-user.target
    enabled: true
    name: kubeadm.service
