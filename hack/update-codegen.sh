#!/usr/bin/env bash

# Copyright 2024 The Kubernetes Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# 	http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

set -euo pipefail
set -x

SCRIPT_ROOT=$(realpath $(dirname "${BASH_SOURCE[0]}"))
PROJECT_ROOT=$(realpath "${SCRIPT_ROOT}/..")
WORKSPACE_ROOT=$(realpath "${PROJECT_ROOT}/hack/codegen")

GENERATED_PKG="pkg/generated"

# Ensure tools built by kube_codegen go in our own GOBIN rather than something
# shared under GOPATH. This guards against these tools being rebuilt by some
# other concurrent invocation, potentially with a different version.
export GOBIN="${WORKSPACE_ROOT}/bin"

cd "$WORKSPACE_ROOT"

# For this to work, the current working directory must be under a Go module which
# lists k8s.io/code-generator
CODEGEN_PKG=$(go list -f '{{ .Dir }}' k8s.io/code-generator)

source "${CODEGEN_PKG}/kube_codegen.sh"

# Deep-copies and what-not are generated by controller-gen, so we don't need to use kube::codegen::gen_helpers

declare -a gen_openapi_args=(
    --report-filename "${PROJECT_ROOT}/api_violations.report"
    --output-dir "${PROJECT_ROOT}/hack/codegen/openapi"
    --output-pkg sigs.k8s.io/cluster-api-provider-openstack/hack/codegen/openapi
    --boilerplate "${SCRIPT_ROOT}/boilerplate.go.txt"

    # We need to include all referenced types in our generated openapi schema
    # or applyconfiguration-gen won't be able to use it. Helpfully it will
    # generate an error including the missing type.
    --extra-pkgs sigs.k8s.io/cluster-api/api/v1beta1
    --extra-pkgs k8s.io/api/core/v1
)

# It is an error to make a change which updates the api violations. When doing
# this intentionally, for example when fixing violations, run with
# UPDATE_API_KNOWN_VIOLATIONS=true to update the api violations report.
if [ ! -z "${UPDATE_API_KNOWN_VIOLATIONS:-}" ]; then
    gen_openapi_args+=(--update-report)
fi

kube::codegen::gen_openapi "${gen_openapi_args[@]}" "${PROJECT_ROOT}/api"

tempdir=$(mktemp -d)
trap 'rm -r "${tempdir}"' EXIT

openapi="${tempdir}/openapi.json"
go run "${PROJECT_ROOT}/hack/codegen/cmd/models-schema/main.go" > "$openapi"

# This hack is required until we're using k8s.io/code-generator containing
# https://github.com/kubernetes/kubernetes/pull/125162, which should be v0.31
ln -s "${PROJECT_ROOT}/api" "${PROJECT_ROOT}/core"
trap 'rm "${PROJECT_ROOT}/core"' EXIT

kube::codegen::gen_client \
    --with-applyconfig \
    --applyconfig-openapi-schema "$openapi" \
    --output-dir "${PROJECT_ROOT}/${GENERATED_PKG}" \
    --output-pkg sigs.k8s.io/cluster-api-provider-openstack/${GENERATED_PKG} \
    --versioned-name clientset \
    --boilerplate "${SCRIPT_ROOT}/boilerplate.go.txt" \
    --one-input-api "api" \
    "${PROJECT_ROOT}"

# Add --with-watch to the above command line to generate informers and listers.
# It's not worth doing that now until we can remove the hack below which
# deletes the clientset.
#    --with-watch \

# The hack below is required until CAPO is using the same version of the k/k
# libraries as the code-generator we're using in this utility module.
#
# code-generator generates code targetting the version of kubernetes it is
# built from. We are fortunate that the generated applyconfiguration builds
# against older libraries. However, the generated clientset does not. As we
# aren't yet using the clientset we just delete it for now.
#
# We could avoid generating it in the first place, but then we wouldn't be able
# to use kube_codegen.sh. We leave it like this as we expect to update to a
# sufficiently new k/k in the relatively near future.
rm -r "${PROJECT_ROOT}/${GENERATED_PKG}/clientset"
